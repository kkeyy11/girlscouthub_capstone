<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Cart - ShopNow</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --primary: #3f704d;
      --secondary: #8dc63f;
      --dark: #2d3436;
      --light: #f9f9f9;
      --gray: #dfe6e9;
      --text: #2d3436;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --radius: 8px;
    }
    * {margin:0;padding:0;box-sizing:border-box;}
    body {font-family:'Poppins',sans-serif;background:#f5f5f5;color:var(--text);}
    .container {max-width:1200px;margin:0 auto;padding:0 20px;}
    header {background:white;box-shadow:var(--shadow);position:sticky;top:0;z-index:100;}
    .header-container {display:flex;justify-content:space-between;align-items:center;padding:15px 0;}
    .logo {font-size:24px;font-weight:700;color:var(--primary);text-decoration:none;display:flex;align-items:center;}
    .logo span {margin-left:8px;}
    nav ul {display:flex;list-style:none;}
    nav ul li {margin-left:25px;}
    nav ul li a, nav ul li button {
      text-decoration:none;color:var(--dark);font-weight:500;
      background:none;border:none;cursor:pointer;font-family:'Poppins',sans-serif;
    }
    nav ul li a:hover, nav ul li button:hover {color:var(--primary);}
    .cart-icon {position:relative;font-size:22px;}
    .cart-count {
      position:absolute;top:-8px;right:-8px;
      background:var(--primary);color:white;font-size:12px;width:18px;height:18px;
      border-radius:50%;display:flex;justify-content:center;align-items:center;
    }
    .page-title {
      font-size:2rem;margin:40px 0 30px;text-align:center;color:var(--dark);
      position:relative;
    }
    .page-title::after {
      content:'';position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);
      width:80px;height:3px;background:var(--primary);
    }
    .cart-container {background:white;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:30px;}
    .cart-items {list-style:none;}
    .cart-item {
      display:flex;justify-content:space-between;align-items:center;
      padding:20px;border-bottom:1px solid var(--gray);
    }
    .cart-item:last-child {border-bottom:none;}
    .cart-item:hover {background:#f9f9f9;}
    .item-details {display:flex;flex-direction:column;}
    .item-name {font-weight:600;color:var(--dark);font-size:1.1rem;margin-bottom:5px;}
    .item-price {color:var(--primary);font-weight:600;font-size:1.2rem;}
    .item-quantity {background:var(--primary);color:white;padding:6px 12px;border-radius:20px;font-size:0.9rem;}
    .cart-summary {background:#f0f7f2;padding:20px;border-top:1px solid #d8e8dd;}
    .cart-total {display:flex;justify-content:space-between;font-size:1.3rem;font-weight:600;color:var(--dark);}
    .total-amount {color:var(--primary);}
    .reservation-form {background:white;border-radius:var(--radius);box-shadow:var(--shadow);padding:30px;margin-bottom:40px;}
    .form-title {font-size:1.5rem;margin-bottom:25px;color:var(--dark);position:relative;}
    .form-title::after {content:'';position:absolute;bottom:-8px;left:0;width:40px;height:3px;background:var(--primary);}
    .form-group {margin-bottom:20px;}
    .form-label {display:block;margin-bottom:8px;font-weight:500;color:var(--dark);}
    .form-input {width:100%;padding:12px 15px;border:1px solid var(--gray);border-radius:var(--radius);}
    .form-input:focus {outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(63,112,77,0.1);}
    .submit-button {background:var(--primary);color:white;border:none;border-radius:var(--radius);padding:14px 20px;font-size:1rem;font-weight:600;cursor:pointer;width:100%;}
    .submit-button:hover {background:#2c5a38;}
    .empty-cart {text-align:center;padding:60px 20px;background:white;border-radius:var(--radius);box-shadow:var(--shadow);}
    .empty-cart-icon {font-size:4rem;margin-bottom:20px;color:#a0a0a0;}
    .empty-cart-message {font-size:1.3rem;color:var(--dark);margin-bottom:30px;}
    .nav-link {display:inline-block;padding:12px 25px;background:var(--primary);color:white;text-decoration:none;border-radius:var(--radius);}
    .nav-link:hover {background:#2c5a38;}
    .continue-shopping {display:block;width:max-content;margin:0 auto 50px;}
    .cancel-button {background:#e74c3c;color:white;border:none;padding:8px 15px;border-radius:var(--radius);font-size:0.9rem;cursor:pointer;}
    .cancel-button:hover {background:#c0392b;}
    .review-button {
      background:#3498db;
      color:white;
      border:none;
      padding:8px 15px;
      border-radius:var(--radius);
      font-size:0.9rem;
      cursor:pointer;
      margin-left:10px;
    }
    .review-button:hover {background:#2980b9;}
    footer {background:var(--dark);color:white;padding:40px 0;margin-top:60px;}
    .footer-container {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:30px;}
    .footer-col h4 {font-size:1.2rem;margin-bottom:20px;position:relative;}
    .footer-col h4::after {content:'';position:absolute;bottom:-8px;left:0;width:40px;height:2px;background:var(--secondary);}
    .footer-col ul {list-style:none;}
    .footer-col ul li {margin-bottom:10px;}
    .footer-col ul li a {color:#ddd;text-decoration:none;}
    .footer-col ul li a:hover {color:var(--secondary);}
    .copyright {text-align:center;padding-top:30px;border-top:1px solid #444;margin-top:30px;font-size:0.9rem;color:#aaa;}
    .modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:999;}
    .modal-content {
      background:white;
      padding:20px;
      border-radius:8px;
      max-width:500px;
      width:90%;
      max-height:80vh;
      overflow-y:auto;
    }
  </style>
</head>
<body>
<header>
  <div class="container header-container">
    <a href="/" class="logo">üõçÔ∏è <span>ShopNow</span></a>
    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/products">Products</a></li>
        <li>
          <button id="historyButton" style="background:var(--secondary);color:white;padding:8px 15px;border:none;border-radius:6px;cursor:pointer;">
            Reservation History
          </button>
        </li>
        <li>
          <a href="/cart" class="cart-icon">üõí
            <span class="cart-count"><%= typeof cart !== 'undefined' && cart.length > 0 ? cart.length : 0 %></span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">
  <h1 class="page-title">Your Shopping Cart</h1>

  <% if (typeof cart !== 'undefined' && cart.length > 0) { %>
  <div class="cart-container">
    <ul class="cart-items">
      <% let total = 0; cart.forEach(item => { total += item.price * item.quantity; %>
      <li class="cart-item">
        <div class="item-details">
          <span class="item-name"><%= item.name %></span>
          <span class="item-price">‚Ç±<%= item.price.toLocaleString() %></span>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;">
          <span class="item-quantity">Qty: <%= item.quantity %></span>
          <span class="item-description" style="font-size:0.9rem;color:#555;max-width:200px;text-align:right;">
            <%= item.description || 'No description provided.' %>
          </span>
        </div>
        <form action="/cancel-item/<%= item._id %>" method="POST">
          <button type="submit" class="cancel-button">Remove</button>
        </form>
      </li>
      <% }); %>
    </ul>
    <div class="cart-summary">
      <div class="cart-total">
        <span>Total:</span>
        <span class="total-amount">‚Ç±<%= total.toLocaleString() %></span>
      </div>
    </div>
  </div>
  <div class="reservation-form">
    <h2 class="form-title">Complete Your Reservation</h2>
    <form action="/reserve" method="POST">
      <div class="form-group">
        <label class="form-label">Your Name</label>
        <input type="text" name="name" required class="form-input"/>
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" name="email" required class="form-input"/>
      </div>
      <div class="form-group">
        <label class="form-label">Contact Number</label>
        <input type="text" name="contact" required class="form-input"/>
      </div>
      <button type="submit" class="submit-button">Confirm Reservation</button>
    </form>
  </div>
  <a href="/products" class="nav-link continue-shopping">Continue Shopping</a>
  <% } else { %>
  <div class="empty-cart">
    <div class="empty-cart-icon">üõí</div>
    <p class="empty-cart-message">Your cart is empty</p>
    <a href="/products" class="nav-link">Browse Products</a>
  </div>
  <% } %>
</div>

<!-- Reservation History Modal -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <h2>Reservation History</h2>
    <% if (typeof reservations !== 'undefined' && reservations.length > 0) { %>
      <ul style="list-style:none;padding:0;">
        <% reservations.forEach(r => { %>
        <li style="border-bottom:1px solid var(--gray);padding:15px 0;">
          <div><strong>Name:</strong> <%= r.name %></div>
          <div><strong>Email:</strong> <%= r.email %></div>
          <div><strong>Contact:</strong> <%= r.contact %></div>
          <div><strong>Total:</strong> ‚Ç±<%= r.total ? r.total.toLocaleString() : '0' %></div>
          <div><strong>Status:</strong>
            <% if (r.status === 'Approved') { %>
              <span style="color:green;font-weight:bold;">Approved</span>
            <% } else { %>
              <span style="color:orange;font-weight:bold;">Pending</span>
            <% } %>
          </div>
          <div><strong>Date:</strong> <%= r.date ? new Date(r.date).toLocaleDateString() : 'N/A' %></div>
          <% if (r.items && r.items.length) { %>
        <div style="margin-top:10px;">
          <strong>Items:</strong>
          <ul style="list-style:none;padding:0;">
            <% r.items.forEach(i => { %>
            <li style="margin-bottom:8px;">
              <div><strong>Product:</strong> <%= i.name %></div>
              <div><strong>Description:</strong> <%= i.description || 'No description' %></div>
              <div><strong>Qty:</strong> <%= i.quantity %></div>
              <div><strong>Price:</strong> ‚Ç±<%= i.price.toLocaleString() %></div>
            </li>
            <% }); %>
          </ul>
        </div>
        <% } %>
          <form action="/delete-reservation/<%= r._id %>" method="POST" style="margin-top:10px;display:inline-block;">
            <button type="submit" class="cancel-button">Delete</button>
          </form>
          <% if (r.status === 'Approved') { %>
            <button class="review-button" onclick="openReviewModal('<%= r._id %>')">Leave Review</button>
            <form method="POST" class="reorderForm" style="display:inline-block;">
              <button type="button" class="review-button reorderBtn" style="background:#27ae60;" data-id="<%= r._id %>">Re-Order</button>
            </form>
          <% } %>
        </li>
        <% }); %>
      </ul>
    <% } else { %>
      <p>No reservation history found.</p>
    <% } %>
    <button id="closeHistory" class="submit-button" style="margin-top:20px;">Close</button>
  </div>
</div>

<!-- Review Modal -->
<div id="reviewModal" class="modal">
  <div class="modal-content">
    <h2>Leave a Review</h2>
    <form id="reviewForm" action="/user/reviews" method="POST">
      <input type="hidden" name="reservationId" id="reservationId" />
      <textarea name="message" rows="4" placeholder="Write your review here..." required></textarea>
      <button type="submit" class="submit-button">Submit Review</button>
    </form>
    <button onclick="closeReviewModal()" class="submit-button" style="margin-top:10px;background:#e74c3c;">Cancel</button>
  </div>
</div>

<!-- Reorder Confirmation Modal -->
<!-- <div id="reorderModal" class="modal">
  <div class="modal-content">
    <h2>Confirm Re-Order</h2>
    <p>Are you sure you want to reorder this reservation?</p>
    <form id="confirmReorderForm" method="POST">
      <button type="submit" class="submit-button">Yes, Re-Order</button>
      <button type="button" onclick="closeReorderModal()" class="submit-button" style="background:#e74c3c;margin-top:10px;">Cancel</button>
    </form>
  </div>
</div> -->
<!-- Enhanced Reorder Confirmation Modal -->
<!-- Enhanced Reorder Confirmation Modal -->
<!-- Enhanced Reorder Confirmation Modal -->
<div id="reorderModal" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <h2>Confirm Re-Order</h2>
    <p style="margin-bottom: 15px; color: #666;">This will create a new reservation with the following items:</p>
    <div id="reorderPreview">
      <!-- Items will be loaded here -->
    </div>
    <div style="margin-top: 20px;">
      <!-- <form id="confirmReorderForm" method="POST">
        <button type="submit" class="submit-button">Yes, Create Reservation</button>
        <button type="button" onclick="closeReorderModal()" class="submit-button" style="background:#e74c3c;margin-top:10px;">Cancel</button>
      </form> -->
      <form id="confirmReorderForm" method="POST">
  <input type="hidden" name="notification" value="Customer re-ordered this reservation." />
  <button type="submit" class="submit-button">Yes, Create Reservation</button>
  <button type="button" onclick="closeReorderModal()" class="submit-button" style="background:#e74c3c;margin-top:10px;">Cancel</button>
</form>

    </div>
  </div>
</div>

<style>
.reorder-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  border-bottom: 1px solid var(--gray);
  background: #f9f9f9;
  border-radius: 6px;
  margin-bottom: 10px;
}

.reorder-item-details {
  flex: 1;
}

.reorder-item-name {
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 5px;
}

.reorder-item-price {
  color: var(--primary);
  font-weight: 500;
}

.reorder-item-qty {
  background: var(--primary);
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.85rem;
  margin-left: 10px;
}

.reorder-total {
  text-align: right;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 2px solid var(--primary);
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--primary);
}

.reorder-warning {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  color: #856404;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 15px;
  font-size: 0.9rem;
}
</style>

<script>
// Enhanced reorder functionality
document.querySelectorAll(".reorderBtn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const reservationId = btn.getAttribute("data-id");
    
    try {
      // Fetch reservation details for preview
      const response = await fetch(`/get-reservation/${reservationId}`);
      const reservation = await response.json();
      
      if (reservation.error) {
        alert('Error loading reservation details');
        return;
      }
      
      // Build the preview HTML
      let previewHTML = '<h3 style="margin-bottom: 15px;">Items for new reservation:</h3>';
      let total = 0;
      let hasWarnings = false;
      let warningMessage = '';
      
      reservation.items.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        
        previewHTML += `
          <div class="reorder-item">
            <div class="reorder-item-details">
              <div class="reorder-item-name">${item.name}</div>
              <div class="reorder-item-price">‚Ç±${item.price.toLocaleString()}</div>
              ${item.description ? `<div style="font-size:0.85rem;color:#666;margin-top:3px;">${item.description}</div>` : ''}
            </div>
            <div class="reorder-item-qty">Qty: ${item.quantity}</div>
          </div>
        `;
        
        // Check for stock warnings (if available in response)
        if (item.stockWarning) {
          hasWarnings = true;
          warningMessage += `‚Ä¢ ${item.name}: ${item.stockWarning}<br>`;
        }
      });
      
      previewHTML += `<div class="reorder-total">Total: ‚Ç±${total.toLocaleString()}</div>`;
      
      // Add warnings if any
      if (hasWarnings) {
        previewHTML = `<div class="reorder-warning"><strong>Stock Warnings:</strong><br>${warningMessage}</div>` + previewHTML;
      }
      
      // Update modal content
      document.getElementById("reorderPreview").innerHTML = previewHTML;
      
      // Set form action
      confirmReorderForm.action = `/reorder/${reservationId}`;
      
      // Show modal
      reorderModal.style.display = "flex";
      
    } catch (error) {
      console.error('Error:', error);
      alert('Error loading reservation details');
    }
  });
});

function closeReorderModal() {
  reorderModal.style.display = "none";
}
</script>

<footer>
  <div class="container footer-container">
    <div class="footer-col"><h4>About Us</h4><ul><li><a href="#">Our Story</a></li></ul></div>
    <div class="footer-col"><h4>Customer Service</h4><ul><li><a href="#">Contact Us</a></li></ul></div>
    <div class="footer-col"><h4>Connect</h4><ul><li><a href="#">Facebook</a></li></ul></div>
  </div>
  <div class="copyright">¬© 2025 ShopNow. All Rights Reserved.</div>
</footer>

<script>
  const historyButton = document.getElementById("historyButton");
  const historyModal = document.getElementById("historyModal");
  const closeHistory = document.getElementById("closeHistory");
  const reviewModal = document.getElementById("reviewModal");
  const reservationIdInput = document.getElementById("reservationId");
  const reorderModal = document.getElementById("reorderModal");
  const confirmReorderForm = document.getElementById("confirmReorderForm");

  historyButton.onclick = () => historyModal.style.display = "flex";
  closeHistory.onclick = () => historyModal.style.display = "none";
  window.onclick = e => {
    if (e.target === historyModal) historyModal.style.display = "none";
    if (e.target === reviewModal) reviewModal.style.display = "none";
    if (e.target === reorderModal) reorderModal.style.display = "none";
  };

  function openReviewModal(reservationId) {
    reservationIdInput.value = reservationId;
    reviewModal.style.display = "flex";
  }
  function closeReviewModal() {
    reviewModal.style.display = "none";
  }
  function closeReorderModal() {
    reorderModal.style.display = "none";
  }

  document.querySelectorAll(".reorderBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const reservationId = btn.getAttribute("data-id");
      confirmReorderForm.action = `/reorder/${reservationId}`;
      reorderModal.style.display = "flex";
    });
  });
</script>
</body>
</html>

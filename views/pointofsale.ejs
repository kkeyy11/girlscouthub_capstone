<%- include('./layouts/navbar') %>

<main class="container my-4">
  <h3 class="text-center mb-4">Point of Sale</h3>

  <!-- CART + Customer Name -->
  <div class="card mx-auto mb-4" style="max-width:600px">
    <div class="card-body">
      <h5>Current Order</h5>
      <input type="text"
        class="form-control mb-2"
        name="customerName"
        placeholder="Customer Name (optional)"
        id="customerName">

      <ul id="cartList" class="list-group mb-3"></ul>
      <h5 class="text-end">Total: ₱<span id="total">0</span></h5>

      <button class="btn btn-success w-100" onclick="openPaymentModal()">Proceed to Payment</button>
    </div>
  </div>

  <div class="row">
    <!-- PRODUCTS -->
    <div class="col-md-8">
      <div class="row">
        <% products.forEach(p => { %>
          <div class="col-md-4 mb-3">
            <div class="card h-100"
              data-bs-toggle="modal"
              data-bs-target="#qtyModal"
              onclick="selectProduct('<%= p._id %>','<%= p.name %>',<%= p.price %>,<%= p.quantity %>)">
              <img src="<%= p.image %>" class="card-img-top">
              <div class="card-body text-center">
                <h6><%= p.name %></h6>
                <small>₱<%= p.price %> | Stock: <%= p.quantity %></small>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- RESERVATIONS -->
    <div class="col-md-4">
      <h5>Approved Reservations</h5>
      <% if(reservations.length === 0){ %>
        <p class="text-muted">No approved reservations</p>
      <% } %>
      <% reservations.forEach(r => { %>
        <div class="card mb-2" style="cursor:pointer;" onclick='loadReservation(<%- JSON.stringify(r) %>)'>
          <div class="card-body">
            <p class="mb-1"><strong><%= r.user ? (r.user.firstName + ' ' + (r.user.middleName ? r.user.middleName + ' ' : '') + r.user.lastName) : "Customer" %></strong></p>
            <p class="mb-0">Total: ₱<%= r.total %></p>
            <small>Status: <%= r.status %></small>
            <ul class="mt-2">
              <% r.items.forEach(item => { %>
                <li style="font-size:0.85rem;"><%= item.name %> x<%= item.quantity %> - ₱<%= item.price %></li>
              <% }) %>
            </ul>
          </div>
        </div>
      <% }) %>
    </div>
  </div>
</main>

<!-- QUANTITY MODAL -->
<div class="modal fade" id="qtyModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Select Quantity</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="number" id="qtyInput" class="form-control" min="1">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="confirmQty()">Add</button>
      </div>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Payment</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Total Due: ₱<span id="modalTotal">0</span></p>
        <input type="number" id="cash" class="form-control mb-3" placeholder="Enter Cash" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary w-100" onclick="processPayment()">PAY</button>
      </div>
    </div>
  </div>
</div>

<!-- INSUFFICIENT CASH MODAL -->
<div class="modal fade" id="cashModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <h5>Insufficient Payment</h5>
        <p>Cash is less than total amount.</p>
        <button class="btn btn-danger" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
let cart = [];
let selectedProduct = null;
let reservationLoaded = false;
let reservationId = null;

function selectProduct(id, name, price, stock){
  if(reservationLoaded) {
    alert("You can only add one reservation at a time. Clear cart first to add products.");
    return;
  }
  selectedProduct = { id, name, price, stock };
  document.getElementById('qtyInput').value = '';
  document.getElementById('qtyInput').max = stock;
}

function confirmQty(){
  const qty = Number(document.getElementById('qtyInput').value);
  if(!qty || qty < 1 || qty > selectedProduct.stock) return alert("Invalid quantity");

  cart.push({
    id: selectedProduct.id,
    name: selectedProduct.name,
    price: selectedProduct.price,
    qty
  });

  renderCart();
  bootstrap.Modal.getInstance(document.getElementById('qtyModal')).hide();
}

function loadReservation(res){
  cart = [];
  reservationLoaded = true;
  reservationId = res._id;

  res.items.forEach(i => {
    cart.push({
      id: i.productId,
      name: i.name,
      price: i.price,
      qty: i.quantity
    });
  });

  document.getElementById('customerName').value = res.user?.firstName 
    ? (res.user.firstName + ' ' + (res.user.middleName ? res.user.middleName + ' ' : '') + res.user.lastName) 
    : '';

  renderCart();
}

function renderCart(){
  let total = 0;
  const list = document.getElementById("cartList");
  list.innerHTML = "";

  cart.forEach((i, idx) => {
    total += i.price * i.qty;
    list.innerHTML += `
      <li class="list-group-item d-flex justify-content-between">
        ${i.name} x${i.qty}
        <span>
          ₱${i.price * i.qty}
          <button class="btn btn-sm btn-danger ms-2" onclick="cart.splice(${idx},1);renderCart(); reservationLoaded=false;">×</button>
        </span>
      </li>`;
  });

  document.getElementById("total").innerText = total;
  document.getElementById("modalTotal").innerText = total;
}

function validateCart(){
  if(cart.length === 0){
    alert("No items selected");
    return false;
  }
  return true;
}

function openPaymentModal(){
  if(!validateCart()) return;
  const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
  paymentModal.show();
}

function processPayment(){
  const cash = Number(document.getElementById('cash').value);
  const total = cart.reduce((sum, i) => sum + i.price * i.qty, 0);

  if(cash < total){
    const cashModal = new bootstrap.Modal(document.getElementById('cashModal'));
    cashModal.show();
    return;
  }

  // Prepare form data
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/pos/pay';
  
  form.innerHTML = `
    <input type="hidden" name="cash" value="${cash}">
    <input type="hidden" name="cart" value='${JSON.stringify(cart)}'>
    <input type="hidden" name="customerName" value="${document.getElementById('customerName').value}">
    <input type="hidden" name="reservationId" value="${reservationId || ''}">
  `;
  
  document.body.appendChild(form);
  form.submit();
}
</script>

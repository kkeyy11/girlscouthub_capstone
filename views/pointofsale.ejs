<%- include('./layouts/navbar') %>

<main class="container my-4">
  <h3 class="text-center mb-4">Point of Sale</h3>

  <!-- CART + Customer Name -->
  <div class="card mx-auto mb-4" style="max-width:600px">
    <div class="card-body">
      <h5>Current Order</h5>
      <input type="text"
        class="form-control mb-2"
        name="customerName"
        placeholder="Customer Name (optional)"
        form="paymentForm">

      <ul id="cartList" class="list-group mb-3"></ul>
      <h5 class="text-end">Total: ₱<span id="total">0</span></h5>

      <form id="paymentForm" method="POST" action="/pos/payment" onsubmit="return validateCart()">
        <input type="hidden" name="cart" id="cartInput">
        <button class="btn btn-success w-100">Proceed to Payment</button>
      </form>
    </div>
  </div>

  <div class="row">
    <!-- PRODUCTS -->
    <div class="col-md-8">
      <div class="row">
        <% products.forEach(p => { %>
          <div class="col-md-4 mb-3">
            <div class="card h-100"
              data-bs-toggle="modal"
              data-bs-target="#qtyModal"
              onclick="selectProduct('<%= p._id %>','<%= p.name %>',<%= p.price %>,<%= p.quantity %>)">
              <img src="<%= p.image %>" class="card-img-top">
              <div class="card-body text-center">
                <h6><%= p.name %></h6>
                <small>₱<%= p.price %> | Stock: <%= p.quantity %></small>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- RESERVATIONS -->
    <div class="col-md-4">
      <h5>Reservations</h5>
      <% if(reservations.length === 0){ %>
        <p class="text-muted">No pending reservations</p>
      <% } %>
      <% reservations.forEach(r => { %>
        <div class="card mb-2" style="cursor:pointer;" onclick='loadReservation(<%- JSON.stringify(r) %>)'>
          <div class="card-body">
            <p class="mb-1"><strong><%= r.user ? (r.user.firstName + ' ' + (r.user.middleName ? r.user.middleName + ' ' : '') + r.user.lastName) : "Customer" %>
</strong></p>
            <p class="mb-0">Total: ₱<%= r.total %></p>
            <small>Status: <%= r.status %></small>
          </div>
        </div>
      <% }) %>
    </div>
  </div>
</main>

<!-- QUANTITY MODAL -->
<div class="modal fade" id="qtyModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Select Quantity</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="number" id="qtyInput" class="form-control" min="1">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="confirmQty()">Add</button>
      </div>
    </div>
  </div>
</div>

<script>
let cart = [];
let selectedProduct = null;

function selectProduct(id, name, price, stock){
  selectedProduct = { id, name, price, stock };
  document.getElementById('qtyInput').value = '';
  document.getElementById('qtyInput').max = stock;
}

function confirmQty(){
  const qty = Number(document.getElementById('qtyInput').value);
  if(!qty || qty < 1 || qty > selectedProduct.stock) return alert("Invalid quantity");

  cart.push({
    id: selectedProduct.id,
    name: selectedProduct.name,
    price: selectedProduct.price,
    qty
  });

  renderCart();
  bootstrap.Modal.getInstance(document.getElementById('qtyModal')).hide();
}

function loadReservation(res){
  cart = [];
  res.items.forEach(i => {
    cart.push({
      id: i.productId,
      name: i.name,
      price: i.price,
      qty: i.quantity
    });
  });

  // Auto-fill customer name from reservation
  document.querySelector("input[name='customerName']").value = res.user?.name || res.user?.username || "";

  renderCart();
}

function renderCart(){
  let total = 0;
  const list = document.getElementById("cartList");
  list.innerHTML = "";

  cart.forEach((i, idx) => {
    total += i.price * i.qty;
    list.innerHTML += `
      <li class="list-group-item d-flex justify-content-between">
        ${i.name} x${i.qty}
        <span>
          ₱${i.price * i.qty}
          <button class="btn btn-sm btn-danger ms-2" onclick="cart.splice(${idx},1);renderCart()">×</button>
        </span>
      </li>`;
  });

  document.getElementById("total").innerText = total;
  document.getElementById("cartInput").value = JSON.stringify(cart);
}

function validateCart(){
  if(cart.length === 0){
    alert("No items selected");
    return false;
  }
  return true;
}
</script>

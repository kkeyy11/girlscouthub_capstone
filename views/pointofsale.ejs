<%- include('./layouts/navbar') %>
<main class="container text-center">
  <% if (customer) { %>
    <h5>User: <%= customer.firstName %> <%= customer.lastName %> (<%= customer.email %>)</h5>
  <% } %>
  <h3 class="mb-4">Point of Sale</h3>

  <!-- CART -->
  <div class="card mx-auto mb-4" style="max-width:600px">
    <div class="card-body">
      <h5 class="card-title">Current Order</h5>
      <ul id="cartList" class="list-group mb-3"></ul>
      <h5 class="text-end">Total: ₱<span id="total">0</span></h5>
      <form method="POST" action="/pos/payment" onsubmit="return validateCart()">
        <input type="hidden" name="cart" id="cartInput">
        <% if (reservationId) { %>
          <input type="hidden" name="reservationId" value="<%= reservationId %>">
        <% } %>
        <button class="btn btn-success w-100">Proceed to Payment</button>
      </form>
      <button class="btn btn-dark w-100 mt-2" onclick="history.back()"><i class="fas fa-arrow-left me-2"></i>Back</button>
    </div>
  </div>

  <!-- PRODUCTS -->
  <div class="row justify-content-center">
    <% products.forEach(p => { %>
      <div class="col-md-3 mb-4">
        <div class="card h-100" onclick="selectProduct('<%= p._id %>','<%= p.name %>',<%= p.price %>,<%= p.quantity %>)" data-bs-toggle="modal" data-bs-target="#qtyModal">
          <img src="<%= p.image %>" class="card-img-top">
          <div class="card-body text-center">
            <h6><%= p.name %></h6>
            <small>₱<%= p.price %> | Stock: <%= p.quantity %></small>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</main>

<!-- QUANTITY MODAL -->
<div class="modal fade" id="qtyModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5>Select Quantity</h5></div>
      <div class="modal-body">
        <input type="number" id="qtyInput" class="form-control" min="1">
        <small class="text-danger mt-1" id="qtyError"></small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="confirmQty()">Add</button>
      </div>
    </div>
  </div>
</div>

<script>
let cart = <%- JSON.stringify(cart) %> || [];
let selectedProduct = {};
let reservationId = "<%= reservationId || '' %>";

function updateCartUI() {
  const cartList = document.getElementById("cartList");
  const totalEl = document.getElementById("total");
  cartList.innerHTML = "";
  let total = 0;
  cart.forEach((item, idx) => {
    total += item.price * item.qty;
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `${item.name} (₱${item.price} x ${item.qty})
      <button class="btn btn-sm btn-danger" onclick="removeCartItem(${idx})"><i class="fas fa-trash"></i></button>`;
    cartList.appendChild(li);
  });
  totalEl.innerText = total;
  document.getElementById("cartInput").value = JSON.stringify(cart);
}

function selectProduct(id,name,price,stock){
  selectedProduct = {id,name,price,stock};
  document.getElementById("qtyInput").value = 1;
  document.getElementById("qtyError").innerText = '';
}

function confirmQty() {
  const qty = Number(document.getElementById("qtyInput").value);
  if (qty < 1 || qty > selectedProduct.stock) {
    document.getElementById("qtyError").innerText = "Invalid quantity!";
    return;
  }
  cart.push({id:selectedProduct.id,name:selectedProduct.name,price:selectedProduct.price,qty:qty});
  updateCartUI();
  var modalEl = document.getElementById('qtyModal');
  var modal = bootstrap.Modal.getInstance(modalEl);
  modal.hide();
}

function removeCartItem(idx){
  cart.splice(idx,1);
  updateCartUI();
}

function validateCart(){
  if(cart.length===0){
    alert("No products in cart!");
    return false;
  }
  return true;
}

// Initial render
updateCartUI();
</script>

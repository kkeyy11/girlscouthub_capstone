<%- include('../layouts/header') %>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Members in District: <%= district.name %></title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      background: #f4f7f6;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 80px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 30px;
    }

    .toggle-box {
      background: linear-gradient(135deg, #46dfb1, #80ee98);
      color: #fff;
      padding: 20px;
      text-align: center;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
      transition: background-color 0.3s;
    }

    .toggle-box:hover {
      background: #60eebf;
    }

    .top-controls,
    .members-container {
      display: none;
    }

    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .search-bar {
      position: relative;
      width: 230px;
    }

    .search-bar input {
      width: 100%;
      padding: 6px 30px 6px 10px;
      border: 1.5px solid #ccc;
      border-radius: 5px;
      font-size: 0.85rem;
    }

    .search-bar i {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      font-size: 0.85rem;
    }

    .export-dropdown {
      position: relative;
    }

    .export-btn {
      background-color: #2f5233;
      color: white;
      padding: 7px 14px;
      border-radius: 5px;
      border: none;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .export-dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: #fff;
      min-width: 160px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 5px;
      z-index: 1;
      flex-direction: column;
    }

    .export-dropdown.show .export-dropdown-content {
      display: flex;
    }

    .export-dropdown-content button {
      padding: 10px 16px;
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      font-size: 0.85rem;
      color: #2f5233;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .export-dropdown-content button:hover {
      background-color: #f0f7ec;
    }

    .members-container {
      background: #fff;
      padding: 25px 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      min-width: 850px;
      background-color: #fff;
      border-radius: 6px;
      overflow: hidden;
    }

    thead th {
      background: linear-gradient(135deg, #46dfb1, #80ee98);
      color: white;
      padding: 8px 10px;
      text-align: center;
      text-transform: uppercase;
    }

    tbody td {
      padding: 6px 10px;
      text-align: center;
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tbody tr:nth-child(odd) {
      background-color: #e8f8f2;
    }

    .no-members {
      text-align: center;
      margin-top: 30px;
      color: #555;
      font-style: italic;
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- Four Toggle Buttons -->
    <div class="toggle-box" data-school="BNHS">üè´ BNHS</div>
    <div class="toggle-box" data-school="CNHS">üè´ CNHS</div>
    <div class="toggle-box" data-school="OMNHS">üè´ OMNHS</div>
    <div class="toggle-box" data-school="CVHS">üè´ CVHS</div>

    <!-- Hidden Controls -->
    <div class="top-controls" id="topControls">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search members..." />
        <i class="fas fa-search"></i>
      </div>
      <div style="display: flex; gap: 12px; align-items: center;">
        <div class="export-dropdown" id="exportDropdown">
          <button class="export-btn" id="exportBtn">
            <i class="fas fa-file-export"></i> Export <i class="fas fa-caret-down"></i>
          </button>
          <div class="export-dropdown-content">
            <button id="exportCSV"><i class="fas fa-file-csv"></i> CSV</button>
            <button id="exportExcel"><i class="fas fa-file-excel"></i> Excel</button>
            <button id="exportPDF"><i class="fas fa-file-pdf"></i> PDF</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Members Table -->
    <div class="members-container" id="membersContainer">
      <h2><i class="fas fa-users"></i> District: <%= district.name %></h2>

      <% if (members.length === 0) { %>
        <p class="no-members">No members in this district.</p>
      <% } else { %>
        <table id="membersTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Date of Birth</th>
              <th>Address</th>
              <th>Contact Number</th>
              <th>Troop #</th>
              <th>School</th>
            </tr>
          </thead>
          <tbody>
            <% members.forEach(m => { %>
              <tr>
                <td><%= m.name %></td>
                <td><%= m.dateOfBirth.toDateString() %></td>
                <td><%= m.address %></td>
                <td><%= m.contactNumber %></td>
                <td><%= m.troopNumber %></td>
                <td><%= m.school %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>
  </div>

  <script>
    const toggleBoxes = document.querySelectorAll('.toggle-box');
    const topControls = document.getElementById('topControls');
    const membersContainer = document.getElementById('membersContainer');
    const exportBtn = document.getElementById('exportBtn');
    const exportDropdown = document.getElementById('exportDropdown');
    const searchInput = document.getElementById('searchInput');

    toggleBoxes.forEach(box => {
      box.addEventListener('click', () => {
        // Hide all toggle buttons
        toggleBoxes.forEach(btn => btn.style.display = 'none');

        // Show search/export and table
        topControls.style.display = 'flex';
        membersContainer.style.display = 'block';
      });
    });

    exportBtn.addEventListener('click', function (e) {
      e.stopPropagation();
      exportDropdown.classList.toggle('show');
    });

    window.addEventListener('click', function (e) {
      if (!exportDropdown.contains(e.target)) {
        exportDropdown.classList.remove('show');
      }
    });

    searchInput.addEventListener('input', function () {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll('#membersTable tbody tr');
      rows.forEach(row => {
        const name = row.querySelector('td:first-child').textContent.toLowerCase();
        row.style.display = name.includes(filter) ? '' : 'none';
      });
    });

    function getVisibleRows() {
      return Array.from(document.querySelectorAll('#membersTable tbody tr'))
        .filter(row => row.style.display !== 'none');
    }

    function tableToCSV() {
      const rows = getVisibleRows();
      const headers = Array.from(document.querySelectorAll('#membersTable thead th'))
        .map(th => `"${th.textContent.trim()}"`);
      const csvRows = [headers.join(',')];
      rows.forEach(row => {
        const cols = Array.from(row.querySelectorAll('td'))
          .map(td => `"${td.textContent.trim()}"`);
        csvRows.push(cols.join(','));
      });
      return csvRows.join('\n');
    }

    document.getElementById('exportCSV').addEventListener('click', () => {
      const csv = tableToCSV();
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'members.csv';
      link.click();
    });

    document.getElementById('exportExcel').addEventListener('click', () => {
      const csv = tableToCSV();
      const blob = new Blob([csv], { type: 'application/vnd.ms-excel;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'members.xls';
      link.click();
    });

    document.getElementById('exportPDF').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape' });

      const rows = getVisibleRows();
      const headers = Array.from(document.querySelectorAll('#membersTable thead th'))
        .map(th => th.textContent.trim());
      const body = rows.map(row =>
        Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim())
      );

      if (doc.autoTable) {
        doc.autoTable({
          head: [headers],
          body: body,
          styles: { fontSize: 8 },
          headStyles: { fillColor: [70, 223, 177] },
          startY: 20,
        });
      } else {
        doc.text('Members List', 14, 15);
      }

      doc.save('members.pdf');
    });
  </script>
</body>
</html>

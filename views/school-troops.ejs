<%- include('./layouts/header') %>
<%- include('./layouts/navbar') %>

<main style="
  margin-left: 220px;
  padding: 80px 30px 30px;
  min-height: 100vh;
  background: linear-gradient(to right top, #e6f9ea, #ccf5e1, #b2f1d8, #98edcf, #7fe9c6);
  font-family: 'Poppins', sans-serif;
">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
  h1 { font-size: 1.6rem; color: #1f2937; font-weight: 700; margin-bottom: 16px; }

  .top-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  .right-actions {
    display: flex;
    gap: 8px;
  }

  .back-link { text-decoration: none; color: #3b82f6; font-weight: 500; font-size: 13px; }
  .back-link:hover { text-decoration: underline; }

  .btn-add, .btn-print {
    padding: 6px 12px;
    color: white;
    font-weight: 600;
    border-radius: 6px;
    text-decoration: none;
    transition: background 0.2s ease;
    border: none;
    cursor: pointer;
    font-size: 13px;
  }
  .btn-add { background-color: #10b981; }
  .btn-add:hover { background-color: #059669; }
  .btn-print { background-color: #2563eb; }
  .btn-print:hover { background-color: #1d4ed8; }

  table { width: 100%; border-collapse: separate; border-spacing: 0 8px; background: transparent; font-size: 13px; }
  thead th {
    background-color: #34d399;
    color: white;
    padding: 10px;
    text-align: left;
    font-weight: 600;
    border-radius: 6px 6px 0 0;
    font-size: 13px;
  }
  tbody tr {
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    transition: transform 0.2s ease;
  }
  tbody tr:hover { transform: scale(1.01); }
  tbody td {
    padding: 10px;
    vertical-align: middle;
    border-bottom: 1px solid #e5e7eb;
    font-size: 13px;
  }

  .action-buttons { display: flex; gap: 6px; align-items: center; }
  .btn-block {
    font-size: 12px;
    font-weight: 600;
    padding: 5px 10px;
    border-radius: 6px;
    text-decoration: none;
    transition: all 0.2s ease;
    color: white;
    border: none;
    cursor: pointer;
  }
  .btn-edit { background-color: #facc15; color: #111827; }
  .btn-block:hover { filter: brightness(0.9); transform: scale(1.02); }

  .btn-delete button {
    all: unset;
    display: inline-block;
    text-align: center;
    color: white;
    cursor: pointer;
    padding: 5px 10px;
    background-color: #ef4444;
    border-radius: 6px;
    font-weight: 600;
    font-size: 12px;
    transition: all 0.2s ease;
  }
  .btn-delete button:hover { filter: brightness(0.9); transform: scale(1.02); }

  form { margin: 0; }

  /* ✅ Modal styling */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    width: 320px;
    max-width: 95%;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .modal-header h2 { margin: 0; font-size: 16px; }
  .close { cursor: pointer; font-size: 18px; font-weight: bold; }
  .modal form { display: flex; flex-direction: column; gap: 8px; }
  .modal input, .modal select {
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 13px;
  }
  .modal button {
    padding: 7px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
  }
  .modal .btn-save { background: #10b981; color: white; }
  .modal .btn-cancel { background: #ef4444; color: white; }

  /* ✅ Print Styling */
  @media print {
    @page { size: A4 portrait; margin: 8mm; }
    body, main { background: #fff !important; font-size: 11px; margin: 0 !important; padding: 0 !important; }
    header, nav, .top-actions, h1, .back-link, .btn-add { display: none !important; }
    .print-container { width: 85% !important; margin: 0 auto !important; }
    .print-heading {
      display: block !important;
      text-align: center;
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 12px;
    }
    th:last-child, td:last-child { display: none !important; }
    table { border-collapse: collapse !important; width: 100% !important; font-size: 11px !important; }
    thead th {
      background: #f0f0f0 !important;
      color: #000 !important;
      border: 1px solid #000 !important;
      padding: 5px !important;
    }
    tbody tr { box-shadow: none !important; transform: none !important; }
    tbody td {
      border: 1px solid #000 !important;
      padding: 5px !important;
      word-break: break-word !important;
    }
  }
  .print-heading { display: none; }
</style>

<h1>Troops in <%= school.name %></h1>

<div class="top-actions">
  <a href="/districts/<%= school.district %>" class="back-link">← Back to Schools</a>
  <div class="right-actions">
    <button id="openAddModal" class="btn-add">+ Add Troop</button>
    <button id="printBtn" class="btn-print">Save / Print PDF</button>
  </div>
</div>

<div class="print-heading">School: <%= school.name %></div>

<div class="print-container">
  <table>
    <thead>
      <tr>
        <th>Troop Leader</th>
        <th>Co-Leader</th>
        <th>Troop No.</th>
        <th>Age Level</th>
        <th>Barangay Committee</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% troops.forEach(t => { %>
        <tr>
          <td><%= t.troopLeader %></td>
          <td><%= t.coLeader %></td>
          <td><%= t.troopNumber %></td>
          <td><%= t.ageLevel %></td>
          <td><%= t.barangayCommittee %></td>
          <td class="action-buttons">
            <button class="btn-block btn-edit" onclick="openEditModal('<%= t._id %>','<%= t.troopLeader %>','<%= t.coLeader %>','<%= t.troopNumber %>','<%= t.ageLevel %>','<%= t.barangayCommittee %>')">Edit</button>
            <form action="/troops/delete/<%= t._id %>" method="POST" class="btn-delete" onsubmit="return confirm('Delete this troop?')">
              <input type="hidden" name="schoolId" value="<%= school._id %>">
              <button type="submit">Delete</button>
            </form>
          </td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>
</main>

<!-- ✅ Add Modal -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add Troop</h2>
      <span class="close" onclick="closeModal('addModal')">&times;</span>
    </div>
    <form action="/addtroop" method="POST">
      <input type="hidden" name="schoolId" value="<%= school._id %>">
      <input type="text" name="troopLeader" placeholder="Troop Leader" required>
      <input type="text" name="coLeader" placeholder="Co-Leader">
      <input type="text" name="troopNumber" placeholder="Troop Number" required>
      <input type="text" name="ageLevel" placeholder="Age Level" required>
      <input type="text" name="barangayCommittee" placeholder="Barangay Committee">
      <button type="submit" class="btn-save">Save</button>
      <button type="button" class="btn-cancel" onclick="closeModal('addModal')">Cancel</button>
    </form>
  </div>
</div>

<!-- ✅ Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Edit Troop</h2>
      <span class="close" onclick="closeModal('editModal')">&times;</span>
    </div>
    <form id="editForm" method="POST">
      <input type="hidden" name="schoolId" value="<%= school._id %>">
      <input type="text" name="troopLeader" id="editTroopLeader" required>
      <input type="text" name="coLeader" id="editCoLeader">
      <input type="text" name="troopNumber" id="editTroopNumber" required>
      <input type="text" name="ageLevel" id="editAgeLevel" required>
      <input type="text" name="barangayCommittee" id="editBarangayCommittee">
      <button type="submit" class="btn-save">Update</button>
      <button type="button" class="btn-cancel" onclick="closeModal('editModal')">Cancel</button>
    </form>
  </div>
</div>

<script>
  document.getElementById("printBtn").addEventListener("click", () => { window.print(); });

  const openModal = (id) => { document.getElementById(id).style.display = "flex"; };
  const closeModal = (id) => { document.getElementById(id).style.display = "none"; };

  document.getElementById("openAddModal").addEventListener("click", () => openModal('addModal'));

  function openEditModal(id, leader, coLeader, number, age, barangay) {
    document.getElementById("editForm").action = `/troops/edit/${id}`;
    document.getElementById("editTroopLeader").value = leader;
    document.getElementById("editCoLeader").value = coLeader;
    document.getElementById("editTroopNumber").value = number;
    document.getElementById("editAgeLevel").value = age;
    document.getElementById("editBarangayCommittee").value = barangay;
    openModal('editModal');
  }
</script>

<%- include('./layouts/footer') %>

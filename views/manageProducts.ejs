<%- include('./layouts/header') %>
<%- include('./layouts/navbar') %>

<style>
:root {
  --primary: #059669;
  --primary-light: #10b981;
  --primary-dark: #047857;
  --secondary: #34d399;
  --accent: #6ee7b7;
  --dark: #1f2937;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  --white: #ffffff;
  --text: #1f2937;
  --text-light: #6b7280;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  --radius: 6px;
  --radius-lg: 10px;
  --radius-xl: 14px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 50%, rgba(5, 150, 105, 0.05) 100%);
  color: var(--text);
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
}

/* Animated background */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="bg-pattern" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1.5" fill="rgba(5,150,105,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23bg-pattern)"/></svg>');
  opacity: 0.3;
  z-index: -1;
}

.container {
  margin-left: 220px;
  padding: 80px 20px 20px; /* Moved lower with more top padding */
  max-width: calc(100% - 240px);
  animation: fadeInUp 0.8s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.page-header {
  margin-bottom: 24px; /* More compact */
  animation: fadeInDown 0.8s ease-out;
}

@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.page-title {
  font-size: 1.8rem; /* More compact */
  font-weight: 700;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.page-title::after {
  content: '';
  position: absolute;
  bottom: -6px;
  left: 0;
  width: 60px;
  height: 3px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border-radius: 2px;
  animation: expandWidth 1s ease-out 0.5s both;
}

@keyframes expandWidth {
  from { width: 0; }
  to { width: 60px; }
}

.page-title i {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* More compact */
  gap: 16px; /* More compact */
  margin-bottom: 24px; /* More compact */
  animation: slideInLeft 0.8s ease-out 0.3s both;
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.stat-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-lg);
  padding: 18px; /* More compact */
  box-shadow: var(--shadow);
  border: 1px solid rgba(255, 255, 255, 0.2);
  position: relative;
  transition: all 0.3s ease;
  overflow: hidden;
  animation: slideInUp 0.6s ease-out both;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }
.stat-card:nth-child(4) { animation-delay: 0.4s; }

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), var(--primary-light), var(--secondary));
  background-size: 200% 100%;
  animation: gradientShift 3s ease-in-out infinite;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-xl);
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px; /* More compact */
}

.stat-title {
  font-size: 0.85rem; /* More compact */
  color: var(--text-light);
  font-weight: 500;
}

.stat-icon {
  width: 36px; /* More compact */
  height: 36px; /* More compact */
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem; /* More compact */
  color: white;
}

.stat-icon.blue { background: linear-gradient(135deg, #42a5f5, #1e88e5); }
.stat-icon.green { background: linear-gradient(135deg, #66bb6a, #43a047); }
.stat-icon.orange { background: linear-gradient(135deg, #ffa726, #fb8c00); }
.stat-icon.red { background: linear-gradient(135deg, #ef5350, #e53935); }

.stat-value {
  font-size: 1.4rem; /* More compact */
  font-weight: 700;
  color: var(--text);
  margin-bottom: 4px;
}

.stat-description {
  font-size: 0.75rem; /* More compact */
  color: var(--text-light);
}

.controls-section {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-lg);
  padding: 16px; /* More compact */
  margin-bottom: 20px; /* More compact */
  box-shadow: var(--shadow);
  border: 1px solid rgba(255, 255, 255, 0.2);
  animation: fadeIn 0.8s ease-out 0.5s both;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.top-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px; /* More compact */
}

.left-buttons, .right-controls {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px; /* More compact */
}

.search-group {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: 8px; /* More compact */
}

.search-group input, .search-group select {
  padding: 8px 10px; /* More compact */
  border: 2px solid var(--gray-200);
  border-radius: var(--radius);
  font-size: 0.85rem; /* More compact */
  font-family: 'Inter', sans-serif;
  transition: all 0.3s ease;
  height: 36px; /* More compact */
}

.search-group input:focus, .search-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
}

.btn {
  padding: 8px 12px; /* More compact */
  border: none;
  border-radius: var(--radius);
  font-size: 0.85rem; /* More compact */
  font-weight: 500;
  cursor: pointer;
  text-decoration: none;
  color: white;
  height: 36px; /* More compact */
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s ease;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.btn-add {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
}

.btn-lowstock {
  background: linear-gradient(135deg, #ffa726, #fb8c00);
}

.btn-export {
  background: linear-gradient(135deg, #ef5350, #e53935);
}

.table-container {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255, 255, 255, 0.2);
  overflow: hidden;
  animation: slideInUp 0.8s ease-out 0.7s both;
}

.table-wrapper {
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem; /* More compact */
}

th, td {
  padding: 10px 8px; /* More compact */
  text-align: left;
  white-space: nowrap;
}

th {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: white;
  font-weight: 600;
  font-size: 0.75rem; /* More compact */
}

td {
  border-bottom: 1px solid var(--gray-100);
  font-size: 0.8rem; /* More compact */
}

tbody tr {
  transition: all 0.3s ease;
}

tbody tr:hover {
  background: rgba(5, 150, 105, 0.05);
  transform: translateX(2px);
}

.product-image {
  width: 40px; /* More compact */
  height: 40px; /* More compact */
  object-fit: cover;
  border-radius: var(--radius);
  border: 1px solid var(--gray-200);
}

.product-name {
  font-weight: 500;
  color: var(--text);
}

.product-price {
  font-weight: 600;
  color: var(--primary);
}

.low-stock {
  color: #ef5350;
  font-weight: 600;
}

.actions-cell {
  display: flex;
  gap: 4px; /* More compact */
  flex-wrap: nowrap;
  align-items: center;
}

.stock-input {
  width: 45px; /* More compact */
  padding: 3px 4px; /* More compact */
  font-size: 0.75rem; /* More compact */
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
}

.actions-cell .btn {
  padding: 3px 6px; /* More compact */
  font-size: 0.7rem; /* More compact */
  height: auto;
  min-width: auto;
}

.btn-edit {
  background: linear-gradient(135deg, #42a5f5, #1e88e5);
}

.btn-delete {
  background: linear-gradient(135deg, #ef5350, #e53935);
}

.btn-add-stock {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
}

.pagination {
  display: flex;
  justify-content: center;
  gap: 6px; /* More compact */
  margin-top: 16px; /* More compact */
  padding: 16px; /* More compact */
  flex-wrap: wrap;
}

.pagination button {
  background: var(--primary);
  color: white;
  padding: 6px 10px; /* More compact */
  border-radius: var(--radius);
  border: none;
  cursor: pointer;
  font-size: 0.8rem; /* More compact */
  transition: all 0.3s ease;
}

.pagination button:hover:not(:disabled) {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.pagination button:disabled {
  background: var(--gray-300);
  cursor: not-allowed;
}

.pagination .active-page {
  background: var(--secondary);
  box-shadow: var(--shadow);
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(5px);
  justify-content: center;
  align-items: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease-out;
}

.modal.flex {
  display: flex;
}

.modal-content {
  background: var(--white);
  padding: 20px; /* More compact */
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  max-height: 85vh; /* More compact */
  overflow: auto;
  width: 90%;
  max-width: 600px; /* More compact */
  position: relative;
  animation: slideInModal 0.3s ease-out;
}

@keyframes slideInModal {
  from {
    opacity: 0;
    transform: translateY(-50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-content h3 {
  font-size: 1.2rem; /* More compact */
  font-weight: 600;
  color: var(--text);
  margin-bottom: 16px; /* More compact */
}

.form-group {
  margin-bottom: 12px; /* More compact */
}

.form-group label {
  display: block;
  font-size: 0.85rem; /* More compact */
  font-weight: 500;
  color: var(--text);
  margin-bottom: 4px;
}

.form-input, .form-input select, .form-input textarea {
  width: 100%;
  padding: 8px 10px; /* More compact */
  border: 2px solid var(--gray-200);
  border-radius: var(--radius);
  font-size: 0.85rem; /* More compact */
  font-family: 'Inter', sans-serif;
  transition: all 0.3s ease;
}

.form-input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
}

.form-section {
  margin-bottom: 16px; /* More compact */
}

.form-section-title {
  font-size: 1rem; /* More compact */
  font-weight: 600;
  color: var(--text);
  margin-bottom: 8px; /* More compact */
  padding-bottom: 4px;
  border-bottom: 2px solid var(--primary);
}

.modal-actions {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  margin-top: 16px; /* More compact */
}

.modal-btn {
  padding: 8px 16px; /* More compact */
  border: none;
  border-radius: var(--radius);
  font-size: 0.85rem; /* More compact */
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.modal-btn.primary {
  background: var(--primary);
  color: white;
}

.modal-btn.primary:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.modal-btn.secondary {
  background: var(--gray-200);
  color: var(--text);
}

.modal-btn.secondary:hover {
  background: var(--gray-300);
  transform: translateY(-1px);
}

/* Responsive Design */
@media (max-width: 768px) {
  .container {
    margin-left: 0;
    padding: 60px 16px 16px; /* Adjusted for mobile */
    max-width: 100%;
  }

  .page-title {
    font-size: 1.5rem;
  }

  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }

  .stat-card {
    padding: 14px;
  }

  .top-controls {
    flex-direction: column;
    align-items: stretch;
  }

  .left-buttons, .right-controls {
    justify-content: center;
  }

  .search-group {
    flex-direction: column;
  }

  .search-group input, .search-group select {
    width: 100%;
  }

  .table-wrapper {
    font-size: 0.75rem;
  }

  .actions-cell {
    flex-direction: column;
    gap: 2px;
  }

  .modal-content {
    width: 95%;
    padding: 16px;
  }
}

@media (max-width: 480px) {
  .container {
    padding: 50px 12px 12px;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }

  .pagination {
    gap: 4px;
  }

  .pagination button {
    padding: 4px 8px;
    font-size: 0.75rem;
  }
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  background: var(--gray-100);
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, var(--primary-light), var(--secondary));
}
</style>

<div class="container">
  <div class="page-header">
    <h1 class="page-title">
      <i class="fas fa-boxes"></i>
      Manage Products
    </h1>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-header">
        <span class="stat-title">Total Items</span>
        <div class="stat-icon blue">
          <i class="fas fa-cubes"></i>
        </div>
      </div>
      <div class="stat-value"><%= products.reduce((sum, p) => sum + p.quantity, 0) %></div>
      <div class="stat-description">Inventory count</div>
    </div>

    <div class="stat-card">
      <div class="stat-header">
        <span class="stat-title">Total Value</span>
        <div class="stat-icon green">
          <i class="fas fa-peso-sign"></i>
        </div>
      </div>
      <div class="stat-value">₱<%= products.reduce((sum, p) => sum + p.price * p.quantity, 0).toFixed(2) %></div>
      <div class="stat-description">Total inventory worth</div>
    </div>

    <div class="stat-card">
      <div class="stat-header">
        <span class="stat-title">Low Stock</span>
        <div class="stat-icon orange">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
      </div>
      <div class="stat-value"><%= products.filter(p => p.quantity > 0 && p.quantity < 10).length %></div>
      <div class="stat-description">Below threshold</div>
    </div>

    <div class="stat-card">
      <div class="stat-header">
        <span class="stat-title">Out of Stock</span>
        <div class="stat-icon red">
          <i class="fas fa-times-circle"></i>
        </div>
      </div>
      <div class="stat-value"><%= products.filter(p => p.quantity === 0).length %></div>
      <div class="stat-description">Zero quantity</div>
    </div>
  </div>

  <div class="controls-section">
    <div class="top-controls">
      <div class="left-buttons">
        <button class="btn btn-add" onclick="openAddProductModal()">
          <i class="fas fa-plus"></i> Add Product
        </button>
        <a href="/low-stock" class="btn btn-lowstock">
          <i class="fas fa-exclamation-circle"></i> View Low Stock
        </a>
      </div>

      <div class="right-controls">
        <div class="search-group">
          <input type="text" id="searchInput" placeholder="Search product name...">
          <select id="categoryFilter">
            <option value="">All Categories</option>
            <% const uniqueCategories = [...new Set(products.map(p => p.category || 'Uncategorized'))]; uniqueCategories.forEach(cat => { %>
              <option value="<%= cat %>"><%= cat %></option>
            <% }); %>
          </select>
        </div>
        <button class="btn btn-export" onclick="showExportPreview()">
          <i class="fas fa-file-pdf"></i> Export
        </button>
      </div>
    </div>
  </div>

  <div class="table-container">
    <div class="table-wrapper" id="exportTable">
      <table id="productTable">
        <thead>
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Category</th>
            <th>Variant</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Date Added</th>
            <th>Last Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="productBody">
          <% products.forEach(p => { %>
            <tr data-category="<%= p.category || 'Uncategorized' %>">
              <td><img src="<%= p.image || 'https://via.placeholder.com/80x80?text=No+Image' %>" class="product-image"></td>
              <td class="product-name"><%= p.name %></td>
              <td><%= p.category || 'Uncategorized' %></td>
              <td><%= p.variant || 'N/A' %></td>
              <td class="product-price">₱<%= p.price %></td>
              <td class="product-quantity <%= p.quantity < 5 ? 'low-stock' : '' %>"><%= p.quantity %></td>
              <td><%= p.createdAt ? p.createdAt.toLocaleDateString() : 'N/A' %></td>
              <td><%= p.updatedAt ? p.updatedAt.toLocaleDateString() : 'N/A' %></td>
              <td class="actions-cell">
                <a href="/edit-product/<%= p._id %>" class="btn btn-edit">
                  <i class="fas fa-edit"></i>
                </a>
                <form action="/delete-product/<%= p._id %>" method="POST" onsubmit="return confirm('Are you sure?');" style="display: inline;">
                  <button class="btn btn-delete">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </form>
                <form action="/add-stock/<%= p._id %>" method="POST" class="stock-form" style="display: flex; gap: 2px;">
                  <input type="number" name="addQty" min="1" placeholder="Qty" required class="stock-input">
                  <button class="btn btn-add-stock">
                    <i class="fas fa-plus"></i>
                  </button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    
    <div class="pagination" id="paginationControls"></div>
  </div>
</div>

<!-- Export Modal -->
<div id="exportModal" class="modal">
  <div class="modal-content">
    <h3>Preview Export</h3>
    <div id="exportPreview"></div>
    <div class="modal-actions">
      <button onclick="downloadPDF()" class="modal-btn primary">
        <i class="fas fa-download"></i> Confirm Export
      </button>
      <button onclick="closeModal()" class="modal-btn secondary">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div id="addProductModal" class="modal">
  <div class="modal-content">
    <h3>Add New Product</h3>
    <form action="/products/add" method="POST" enctype="multipart/form-data">
      <div class="form-group">
        <label class="required">Image:</label>
        <input type="file" name="image" accept="image/*" class="form-input">
      </div>

      <div class="form-section">
        <div class="form-section-title">Basic Information</div>
        <div class="form-group">
          <label class="required">Product Name:</label>
          <input type="text" name="name" class="form-input" required>
        </div>

        <div class="form-group">
          <label class="required">Category:</label>
          <select id="category" name="category" class="form-input" required>
            <option value="">-- Select Category --</option>
            <option value="Uniform">Uniform</option>
            <option value="Camping Gear">Camping Gear</option>
            <option value="Accessories">Accessories</option>
            <option value="Badges">Badges</option>
          </select>
        </div>

        <div class="form-group" id="subcategory-group" style="display:none;">
          <label class="required">Subcategory:</label>
          <select id="subcategory" name="subcategory" class="form-input">
            <option value="">-- Select Subcategory --</option>
            <option value="TWINKLER BADGES">TWINKLER BADGES</option>
            <option value="STAR BADGES">STAR BADGES</option>
            <option value="JUNIOR BADGES">JUNIOR BADGES</option>
            <option value="SENIOR BADGES">SENIOR BADGES</option>
            <option value="CADET BADGES">CADET BADGES</option>
            <option value="SPECIAL BADGES">SPECIAL BADGES</option>
          </select>
        </div>

        <div class="form-group" id="variant-group" style="display:none;">
          <label>Variant (Optional):</label>
          <select id="variant" name="variant" class="form-input">
            <option value="">-- Select Size --</option>
            <option value="S">Small (S)</option>
            <option value="M">Medium (M)</option>
            <option value="L">Large (L)</option>
            <option value="XL">Extra Large (XL)</option>
            <option value="XXL">2XL (XXL)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Description:</label>
          <textarea name="description" class="form-input" rows="3"></textarea>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">Inventory Information</div>
        <div class="form-group">
          <label class="required">Quantity:</label>
          <input type="number" name="quantity" min="0" class="form-input" required>
        </div>

        <div class="form-group">
          <label class="required">Price (₱):</label>
          <input type="number" step="0.01" name="price" min="0" class="form-input" required>
        </div>

        <div class="form-group">
          <label>Supplier:</label>
          <input type="text" name="supplier" class="form-input">
        </div>

        <div class="form-group">
          <label>Date Acquired:</label>
          <input type="date" name="dateAcquired" class="form-input">
        </div>
      </div>

      <div class="modal-actions">
        <button type="submit" class="modal-btn primary">
          <i class="fas fa-save"></i> Add Product
        </button>
        <button type="button" onclick="closeAddProductModal()" class="modal-btn secondary">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const category = document.getElementById("category");
  const subcategoryGroup = document.getElementById("subcategory-group");
  const subcategory = document.getElementById("subcategory");
  const variantGroup = document.getElementById("variant-group");

  function updateFields() {
    const selectedCategory = category.value;

    if (selectedCategory === "Badges") {
      subcategoryGroup.style.display = "block";
      subcategory.required = true;
    } else {
      subcategoryGroup.style.display = "none";
      subcategory.required = false;
      subcategory.value = "";
    }

    if (selectedCategory === "Uniform") {
      variantGroup.style.display = "block";
    } else {
      variantGroup.style.display = "none";
      document.getElementById("variant").value = "";
    }
  }

  category.addEventListener("change", updateFields);
  updateFields();
});

const searchInput = document.getElementById('searchInput');
const categoryFilter = document.getElementById('categoryFilter');
const tbody = document.getElementById('productBody');
const pagination = document.getElementById('paginationControls');
const rowsPerPage = 5;
let currentPage = 1;
const allRows = Array.from(tbody.querySelectorAll('tr')); 
let rows = [...allRows];

function renderTable(page = 1) {
  tbody.innerHTML = "";
  let start = (page - 1) * rowsPerPage;
  let end = start + rowsPerPage;
  rows.slice(start, end).forEach(row => tbody.appendChild(row));
  renderPagination();
}

function renderPagination() {
  const totalPages = Math.max(Math.ceil(rows.length / rowsPerPage), 1);
  pagination.innerHTML = "";

  const prevBtn = document.createElement('button');
  prevBtn.textContent = 'Previous';
  prevBtn.disabled = currentPage === 1;
  prevBtn.onclick = () => {
    if (currentPage > 1) {
      currentPage--;
      renderTable(currentPage);
    }
  };
  pagination.appendChild(prevBtn);

  for (let i = 1; i <= totalPages; i++) {
    const pageBtn = document.createElement('button');
    pageBtn.textContent = i;
    if (i === currentPage) pageBtn.classList.add('active-page');
    pageBtn.onclick = () => {
      currentPage = i;
      renderTable(currentPage);
    };
    pagination.appendChild(pageBtn);
  }

  const nextBtn = document.createElement('button');
  nextBtn.textContent = 'Next';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.onclick = () => {
    if (currentPage < totalPages) {
      currentPage++;
      renderTable(currentPage);
    }
  };
  pagination.appendChild(nextBtn);
}

searchInput.addEventListener('input', filterRows);
categoryFilter.addEventListener('change', filterRows);

function filterRows() {
  const searchVal = searchInput.value.toLowerCase();
  const selectedCategory = categoryFilter.value;

  rows = allRows.filter(row => {
    const nameMatch = row.querySelector('.product-name').textContent.toLowerCase().includes(searchVal);
    const categoryMatch = selectedCategory === "" || row.getAttribute('data-category') === selectedCategory;
    return nameMatch && categoryMatch;
  });

  currentPage = 1;
  renderTable();
}

renderTable();

function showExportPreview() {
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const table = document.getElementById('productTable');
  const clone = table.cloneNode(true);
  const tbodyClone = clone.querySelector('tbody');
  tbodyClone.innerHTML = '';

  rows.slice(start, end).forEach(tr => {
    const rowClone = tr.cloneNode(true);
    rowClone.querySelector('.actions-cell')?.remove();
    tbodyClone.appendChild(rowClone);
  });

  clone.querySelectorAll('th:last-child').forEach(th => th.remove());
  document.getElementById('exportPreview').innerHTML = '';
  document.getElementById('exportPreview').appendChild(clone);
  document.getElementById('exportModal').classList.add('flex');
}

function downloadPDF() {
  const preview = document.getElementById('exportPreview').cloneNode(true);
  html2pdf().set({ 
    margin: 0.3, 
    filename: 'product-report.pdf', 
    image: { type: 'jpeg', quality: 0.98 }, 
    html2canvas: { scale: 2 }, 
    jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' } 
  }).from(preview).save();
  closeModal();
}

function closeModal() { 
  document.getElementById('exportModal').classList.remove('flex'); 
}

function openAddProductModal() { 
  document.getElementById('addProductModal').classList.add('flex'); 
}

function closeAddProductModal() { 
  document.getElementById('addProductModal').classList.remove('flex'); 
}

// Close modals when clicking outside
window.onclick = function(event) {
  const exportModal = document.getElementById('exportModal');
  const addModal = document.getElementById('addProductModal');
  
  if (event.target === exportModal) {
    closeModal();
  }
  if (event.target === addModal) {
    closeAddProductModal();
  }
};

// Close modals with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeModal();
    closeAddProductModal();
  }
});
</script>

<%- include('./layouts/footer') %>

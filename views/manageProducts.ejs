<%- include('./layouts/header') %>
<%- include('./layouts/navbar') %>

<style>
main {
  margin-left: 220px;              
  padding: 90px 20px 30px;         
  min-height: 100vh;
  background-color: #f9fafb;
  box-sizing: border-box;
  font-family: 'Inter', sans-serif;
}

/* Table alternate row colors */
#productTable tbody tr:nth-child(odd) { background-color: #ffffff; }
#productTable tbody tr:nth-child(even) { background-color: #e6f9ea; }
#productTable tbody tr:hover { background-color: #ccf5e1 !important; transition: 0.3s; }

/* Cards */
.card { border-radius: 10px; }
.card-body { padding: 20px; }

/* Responsive adjustments */
@media (max-width: 768px) {
  main { margin-left: 0; padding: 100px 15px 30px; }
}
</style>

<main>
  <div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
      <div class="col-12">
        <h1 class="h3 fw-bold text-success d-flex align-items-center gap-2">
          <i class="fas fa-boxes"></i> Products
        </h1>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="row g-3 mb-4">
      <div class="col-sm-6 col-lg-3">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted small">Total Items</span>
              <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width:36px; height:36px;">
                <i class="fas fa-cubes text-white"></i>
              </div>
            </div>
            <h5 class="fw-bold mb-0"><%= products.reduce((sum, p) => sum + p.quantity, 0) %></h5>
            <small class="text-muted">Inventory count</small>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted small">Total Value</span>
              <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width:36px; height:36px;">
                <i class="fas fa-peso-sign text-white"></i>
              </div>
            </div>
            <h5 class="fw-bold mb-0">â‚±<%= products.reduce((sum, p) => sum + p.price * p.quantity, 0).toFixed(2) %></h5>
            <small class="text-muted">Total inventory worth</small>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted small">Low Stock</span>
              <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width:36px; height:36px;">
                <i class="fas fa-exclamation-triangle text-white"></i>
              </div>
            </div>
            <h5 class="fw-bold mb-0"><%= products.filter(p => p.quantity > 0 && p.quantity < 10).length %></h5>
            <small class="text-muted">Below threshold</small>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted small">Out of Stock</span>
              <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center" style="width:36px; height:36px;">
                <i class="fas fa-times-circle text-white"></i>
              </div>
            </div>
            <h5 class="fw-bold mb-0"><%= products.filter(p => p.quantity === 0).length %></h5>
            <small class="text-muted">Zero quantity</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <i class="fas fa-plus"></i> Add Product
          </button>
          <button class="btn btn-warning text-white" data-bs-toggle="modal" data-bs-target="#lowStockModal">
            <i class="fas fa-exclamation-circle"></i> View Low Stock
          </button>
          <a href="/inventory-report" class="btn btn-info text-white">
            <i class="fas fa-chart-bar"></i> Reports
          </a>
        </div>
        <div class="d-flex gap-2">
          <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search product name...">
          <select id="categoryFilter" class="form-select form-select-sm">
            <option value="">All Categories</option>
            <% const uniqueCategories = [...new Set(products.map(p => p.category || 'Uncategorized'))]; uniqueCategories.forEach(cat => { %>
              <option value="<%= cat %>"><%= cat %></option>
            <% }); %>
          </select>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card shadow-sm border-0">
      <div class="table-responsive">
        <table class="table align-middle" id="productTable">
          <thead class="table-success">
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>Category</th>
              <th>Variant</th>
              <th>Price</th>
              <th>Quantity</th>
              <th>Date Added</th>
              <th>Last Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productBody">
            <% products.forEach(p => { %>
              <tr data-category="<%= p.category || 'Uncategorized' %>">
                <td><img src="<%= p.image || 'https://via.placeholder.com/80x80?text=No+Image' %>" class="img-thumbnail" style="width:40px; height:40px; object-fit:cover;"></td>
                <td class="fw-semibold"><%= p.name %></td>
                <td><%= p.category || 'Uncategorized' %></td>
                <td><%= p.variant || 'N/A' %></td>
                <td class="text-success fw-bold">â‚±<%= p.price %></td>
                <td class="<%= p.quantity < 5 ? 'text-danger fw-bold' : '' %>"><%= p.quantity %></td>
                <td><%= p.createdAt ? p.createdAt.toLocaleDateString() : 'N/A' %></td>
                <td><%= p.updatedAt ? p.updatedAt.toLocaleDateString() : 'N/A' %></td>
                <td>
                  <div class="d-flex gap-1">
                    <a href="/edit-product/<%= p._id %>" class="btn btn-primary btn-sm"><i class="fas fa-edit"></i></a>
                    <form action="/delete-product/<%= p._id %>" method="POST" onsubmit="return confirm('Are you sure?');">
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash-alt"></i></button>
                    </form>
                    <form action="/add-stock/<%= p._id %>" method="POST" class="d-flex gap-1">
                      <input type="number" name="addQty" min="1" placeholder="Qty" required class="form-control form-control-sm" style="width:60px;">
                      <button class="btn btn-success btn-sm"><i class="fas fa-plus"></i></button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form action="/products/add" method="POST" enctype="multipart/form-data">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Add New Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Image</label>
            <input type="file" name="image" accept="image/*" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Product Name</label>
            <input type="text" name="name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select id="category" name="category" class="form-select" required>
              <option value="">-- Select Category --</option>
              <option value="Uniform">Uniform</option>
              <option value="Camping Gear">Camping Gear</option>
              <option value="Accessories">Accessories</option>
              <option value="Badges">Badges</option>
            </select>
          </div>
          <div class="mb-3 d-none" id="subcategory-group">
            <label class="form-label">Subcategory</label>
            <select id="subcategory" name="subcategory" class="form-select">
              <option value="">-- Select Subcategory --</option>
              <option value="TWINKLER BADGES">TWINKLER BADGES</option>
              <option value="STAR BADGES">STAR BADGES</option>
              <option value="JUNIOR BADGES">JUNIOR BADGES</option>
              <option value="SENIOR BADGES">SENIOR BADGES</option>
              <option value="CADET BADGES">CADET BADGES</option>
              <option value="SPECIAL BADGES">SPECIAL BADGES</option>
            </select>
          </div>
          <div class="mb-3 d-none" id="variant-group">
            <label class="form-label">Variant (Optional)</label>
            <select id="variant" name="variant" class="form-select">
              <option value="">-- Select Size --</option>
              <option value="S">Small (S)</option>
              <option value="M">Medium (M)</option>
              <option value="L">Large (L)</option>
              <option value="XL">Extra Large (XL)</option>
              <option value="XXL">2XL (XXL)</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Price</label>
            <input type="number" name="price" class="form-control" step="0.01" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input type="number" name="quantity" class="form-control" min="0" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" rows="3" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Save Product</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Low Stock Modal -->
<div class="modal fade" id="lowStockModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title"><i class="fas fa-exclamation-circle"></i> Low Stock Products</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <% const lowStock = products.filter(p => p.quantity > 0 && p.quantity < 10); %>
        <% if (lowStock.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-warning">
                <tr>
                  <th>Image</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Quantity</th>
                </tr>
              </thead>
              <tbody>
                <% lowStock.forEach(p => { %>
                  <tr>
                    <td><img src="<%= p.image || 'https://via.placeholder.com/80x80?text=No+Image' %>" class="img-thumbnail" style="width:40px; height:40px; object-fit:cover;"></td>
                    <td><%= p.name %></td>
                    <td><%= p.category || 'Uncategorized' %></td>
                    <td class="text-danger fw-bold"><%= p.quantity %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="alert alert-success text-center">
            ðŸŽ‰ All products are sufficiently stocked!
          </div>
        <% } %>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Show/Hide Subcategory and Variant fields
  const categorySelect = document.getElementById("category");
  const subcategoryGroup = document.getElementById("subcategory-group");
  const variantGroup = document.getElementById("variant-group");

  function toggleFields() {
    const value = categorySelect.value;
    subcategoryGroup.classList.add("d-none");
    variantGroup.classList.add("d-none");
    if (value === "Badges") subcategoryGroup.classList.remove("d-none");
    if (value === "Uniform") variantGroup.classList.remove("d-none");
  }

  toggleFields();
  categorySelect.addEventListener("change", toggleFields);

  // Category filter functionality
  const categoryFilter = document.getElementById("categoryFilter");
  const searchInput = document.getElementById("searchInput");
  const productBody = document.getElementById("productBody");

  function filterTable() {
    const search = searchInput.value.toLowerCase();
    const category = categoryFilter.value;

    Array.from(productBody.children).forEach(row => {
      const name = row.children[1].textContent.toLowerCase();
      const rowCategory = row.dataset.category;
      const matchSearch = name.includes(search);
      const matchCategory = category === "" || rowCategory === category;
      row.style.display = matchSearch && matchCategory ? "" : "none";
    });
  }

  searchInput.addEventListener("input", filterTable);
  categoryFilter.addEventListener("change", filterTable);
</script>

<%- include('./layouts/footer') %>
